{"id":346,"date":"2020-12-05T16:05:51","date_gmt":"2020-12-05T21:05:51","guid":{"rendered":"http:\/\/virtualizedtaylor.com\/?p=346"},"modified":"2021-05-16T09:44:09","modified_gmt":"2021-05-16T14:44:09","slug":"automating-csr-and-esxi-deployments-with-ansible","status":"publish","type":"post","link":"https:\/\/virtualizedtaylor.wpcomstaging.com\/2020\/12\/05\/automating-csr-and-esxi-deployments-with-ansible\/","title":{"rendered":"Automating CSR and ESXI Deployments with Ansible!"},"content":{"rendered":"\n<p>Labbing is an important way to improve your skills and gain experiences with new technologies! There are tons of ways to Lab with a lot of professionals transitioning from Physical to Virtual Labs especially with CML, GNS3 and EVE-NG. In my Lab, I have been using a lot of Virtual Appliances (CSR, FTDv, PALOv, ESXI, etc) as I prefer to run directly on the Hypervisor\/Network without introducing additional layers of virtualization if possible. <\/p>\n\n\n\n<p>When running directly on the hypervisor\/network, you lose the ability to &#8220;drag a router&#8221; onto your topology and cable it up. Instead you need to deploy an OVA and populate all the parameters before it is ready to go. Doing this once or twice is fine but if you are looking to deploy 10 virtual CSRs it becomes a lot of repeat clicking and importing. <strong>So I automated this with Ansible<\/strong>!<\/p>\n\n\n\n<p>This code is publically available on <a href=\"https:\/\/github.com\/VirTaylor\/deploy_ova_public\">my github (@VirTaylor)<\/a>! It is currently set up for the CSRs running IOS XE 17.2 as well as the Nested ESXI OVA that has been made famous by <a href=\"https:\/\/www.virtuallyghetto.com\/nested-virtualization\/nested-esxi-virtual-appliance\">William Lam at VirtuallyGhetto.<\/a> I have plans to create\/update to support the deployment of FTDv and PALOv but in theory this could be adapted to deploy an OVA. Lets see how it works!<\/p>\n\n\n\n<p>At the core, the playbooks leveragte the community.vmware collection that is available from <a href=\"https:\/\/galaxy.ansble.com\" rel=\"nofollow\">https:\/\/galaxy.ansble.com<\/a>. This allows the &#8220;deploy_ovf&#8221; module to be called within the playbook. I have structured all the tasks in each of the &#8220;main.yml&#8221; files to leverage variables which are defined and controlled in the &#8220;answerfile.yml&#8221;.<\/p>\n\n\n\n<pre class=\"wp-block-syntaxhighlighter-code\"># Infrastructure\nvcenter: \"enter-fqdn-or-ip-of-vcenter\" # vcsa.lab.local\nvc_user: \"enter-username-of-ansible-account-to-deploy-ova\" # administrator@vsphere.local\nvc_pass: \"enter-password-of-ansible-account-to-deploy-ova\" # Password123\nvc_dc: \"enter-name-of-destination-dataceter\" # Lab Datacenter\nvc_cluster: \"enter-name-of-destination-cluster\" # Lab Cluster\ndatastore: \"enter-name-destination-datastore\" # datastore1\n\n# CSR Deployment Options\ncsr_abs_ova_path: \"enter-absolute-path-of-ova\" # \/mnt\/s\/Cisco\/csr1000v-universalk9.17.02.02.ova\ncsr_folder: \"enter-vsphere-folder-path-for-organizartion\" # Datacenter\/vm\/CSR\ncsr_gig1: \"enter-port-group-for-interface3\" # VM Network\ncsr_gig2: \"enter-port-group-for-interface1\" # VM Network\ncsr_gig3: \"enter-port-group-for-interface3\" # VM Network\ncsr_admin_username: \"enter-default-admin-username\" # admin\ncsr_admin_password: \"enter-default-admin-password\" # Password123\ncsr_domain_name: \"enter-domain-name\" # lab.local\ncsr_mgmt_mask: \"enter-mgmt-subnet-mask\" # 255.255.255.0\ncsr_enable_password: \"enter-enable-password\" # Enable123\ncsr_license_level: \"ax\" # ax\ncsr_mgmt_gateway: \"enter-mgmt-gateway\" # 10.10.10.1\n\n# ESXI Deployment Options\nesxi_abs_ova_path: \"enter-absolute-path-of-ova\" # \/mnt\/s\/ESXI\/Nested_ESXi7.0u1_Appliance_Template_v1.ova\nesxi_folder: \"enter-vsphere-folder-path-for-organizartion\" # Datacenter\/vm\/ESXI\nesxi_int: \"enter-port-group-for-interface\" # VM Network\nesxi_root_password: \"enter-nexted-esxi-root-password\" # Password123\nesxi_domain_name: \"enter-domain-name\" # lab.local\nesxi_mgmt_mask: enter-mgmt-subnet-mask\" # 255.255.255.0\nesxi_mgmt_gateway: \"enter-mgmt-gateway\" # 10.10.10.1\nesxi_mgmt_vlan: \"enter-mgmt-vlan-id\" # 1\nesxi_dns_servers: \"enter-dns-servers-comma-seperated\" # 10.10.10.1, 10.10.10.2<\/pre>\n\n\n\n<p>These values are referenced during the deployment\/configuration of the Virtual Appliances. You may be wondering how we are able to configure the appliance during deployment. With every OVA, there are a series of &#8220;VAPP Properties&#8221; that are defined and then passed through to the VM during the boot process. You can view these values by going to the following configuration path within vCenter.<\/p>\n\n\n\n<p>Name of Virtual Machine -&gt; Configure -&gt; Settings -&gt; VAPP Properties. If you are looking at a CSR, it will look something like this:<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" decoding=\"async\" width=\"700\" height=\"217\" data-attachment-id=\"353\" data-permalink=\"https:\/\/virtualizedtaylor.wpcomstaging.com\/screen-shot-2020-12-05-at-3-41-02-pm\/\" data-orig-file=\"https:\/\/i0.wp.com\/virtualizedtaylor.wpcomstaging.com\/wp-content\/uploads\/2020\/12\/screen-shot-2020-12-05-at-3.41.02-pm.png?fit=2672%2C830&amp;ssl=1\" data-orig-size=\"2672,830\" data-comments-opened=\"1\" data-image-meta=\"{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}\" data-image-title=\"screen-shot-2020-12-05-at-3.41.02-pm\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https:\/\/i0.wp.com\/virtualizedtaylor.wpcomstaging.com\/wp-content\/uploads\/2020\/12\/screen-shot-2020-12-05-at-3.41.02-pm.png?fit=300%2C93&amp;ssl=1\" data-large-file=\"https:\/\/i0.wp.com\/virtualizedtaylor.wpcomstaging.com\/wp-content\/uploads\/2020\/12\/screen-shot-2020-12-05-at-3.41.02-pm.png?fit=700%2C217&amp;ssl=1\" src=\"https:\/\/i0.wp.com\/virtualizedtaylor.wpcomstaging.com\/wp-content\/uploads\/2020\/12\/screen-shot-2020-12-05-at-3.41.02-pm.png?resize=700%2C217&#038;ssl=1\" alt=\"\" class=\"wp-image-353\" data-recalc-dims=\"1\" \/><figcaption>VAPP Properties of a Virtual Cloud Service Router<\/figcaption><\/figure>\n\n\n\n<p>These values are setup as a Key Value Pair and are also visable when you deploy the OVA Manual. Often there are additional keys that can be leveraged and understood by the deployment. For example the CSRs will understand the following:<\/p>\n\n\n\n<pre class=\"wp-block-syntaxhighlighter-code\"> id: com.cisco.csr1000v.ios-config-000X.1\n type: string\n value: insert_standard_ios_configuration_here<\/pre>\n\n\n\n<p>This allows you to enter any IOS configuration that is installed to the configuration on first bootup. I am using this to create a Management VRF and configure GigabitEthernet3 as the Management Interface. The options are endless, you can theoretically pass the configuration for TACACS or your initial dynamic routing configuration. Just make sure to increment the X in the ID for each command (1 being the first command).<\/p>\n\n\n\n<p>So how do I run this in my environment?<\/p>\n\n\n\n<p>First you should validate that you have installed the various packages that are listed in the repository on github. Then you will want to update the answerfile.yml and inventory file to match your environment and specifications. You may be required to download the appropriate OVAs if those are not readily available. If you are only using this code to deploy the CSRs, you can skip the handful of variables that are within the ESXI Deployment section. When it is time to run the playbook, use the following command:<\/p>\n\n\n\n<pre class=\"wp-block-syntaxhighlighter-code\">ansible-playbook deploy_ova.yml -i inventory -l &lt;host_group&gt;<\/pre>\n\n\n\n<p>The &#8220;-l &lt;host_group&gt; is not required if you have a clean and commented inventory file. <\/p>\n\n\n\n<p>Reach out on Twitter (@VirTaylor) if you are using my code. I want to know the things that work well and the things that do not work at all! Intend to keep expanding on this to include additional products! If you have any recommendations do not be shy!<\/p>\n\n\n\n<p>Happy Automating!<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Labbing is an important way to improve your skills and gain experiences with new technologies! There are tons of ways to Lab with a lot of professionals transitioning from Physical to Virtual Labs especially with CML, GNS3 and EVE-NG. In my Lab, I have been using a lot of Virtual Appliances (CSR, FTDv, PALOv, ESXI, &hellip; <a href=\"https:\/\/virtualizedtaylor.wpcomstaging.com\/2020\/12\/05\/automating-csr-and-esxi-deployments-with-ansible\/\" class=\"more-link\">Continue reading <span class=\"screen-reader-text\">Automating CSR and ESXI Deployments with Ansible!<\/span> <span class=\"meta-nav\">&rarr;<\/span><\/a><\/p>\n","protected":false},"author":62406288,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":true,"template":"","format":"standard","meta":{"_coblocks_attr":"","_coblocks_dimensions":"","_coblocks_responsive_height":"","_coblocks_accordion_ie_support":"","advanced_seo_description":"","jetpack_seo_html_title":"","jetpack_seo_noindex":false,"jetpack_post_was_ever_published":false,"_jetpack_newsletter_access":"","_jetpack_dont_email_post_to_subs":false,"_jetpack_newsletter_tier_id":0,"footnotes":"","jetpack_publicize_message":"Been working on this for a while now... Time to share my @Ansble for  #Cisco CSR and #VMware ESXI Deployments! #AONE @Cisco @VMware #vExpert #Automation #DevNet ","jetpack_publicize_feature_enabled":true,"jetpack_social_post_already_shared":false,"jetpack_social_options":{"image_generator_settings":{"template":"highway","enabled":false}}},"categories":[4011177,44070,28532,38600],"tags":[],"jetpack_publicize_connections":[],"jetpack_featured_media_url":"","jetpack_likes_enabled":true,"jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/paI6yL-5A","jetpack-related-posts":[],"_links":{"self":[{"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/posts\/346"}],"collection":[{"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/users\/62406288"}],"replies":[{"embeddable":true,"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/comments?post=346"}],"version-history":[{"count":10,"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/posts\/346\/revisions"}],"predecessor-version":[{"id":357,"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/posts\/346\/revisions\/357"}],"wp:attachment":[{"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/media?parent=346"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/categories?post=346"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/virtualizedtaylor.wpcomstaging.com\/wp-json\/wp\/v2\/tags?post=346"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}